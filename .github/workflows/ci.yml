name: CI

on:
  push:
    branches: [ master ]
  pull_request:
    branches: [ master  ]
  workflow_dispatch:  # This allows manual triggering

jobs:
  test-backend:
    runs-on: ubuntu-latest
    
    services:
      mysql:
        image: mysql:8.0
        env:
          MYSQL_ROOT_PASSWORD: root
          MYSQL_DATABASE: fritid_db
          MYSQL_USER: fritid_user
          MYSQL_PASSWORD: fritid_password
        ports:
          - 3306:3306
        options: --health-cmd="mysqladmin ping" --health-interval=10s --health-timeout=5s --health-retries=3

    steps:
      - uses: actions/checkout@v4
      
      - uses: actions/setup-node@v4
        with:
          node-version: 20
          
      - name: Install backend dependencies
        run: npm ci
        working-directory: ./backend
        
      - name: Wait for MySQL
        run: |
          until mysqladmin ping -h"127.0.0.1" --silent; do
            echo 'waiting for mysqladmin to be connectable...'
            sleep 2
          done
          
      - name: Setup database
        run: |
          # Create basic tables for testing
          mysql -h 127.0.0.1 -u fritid_user -pfritid_password fritid_db << 'EOF'
          CREATE TABLE IF NOT EXISTS users (
            id INT PRIMARY KEY AUTO_INCREMENT,
            email VARCHAR(255) UNIQUE NOT NULL,
            password VARCHAR(255) NOT NULL,
            firstName VARCHAR(100),
            lastName VARCHAR(100),
            role ENUM('user', 'admin') DEFAULT 'user',
            isActive BOOLEAN DEFAULT true,
            createdAt TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
            updatedAt TIMESTAMP DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP
          );

          CREATE TABLE IF NOT EXISTS products (
            id INT PRIMARY KEY AUTO_INCREMENT,
            name VARCHAR(255) NOT NULL,
            description TEXT,
            price DECIMAL(10,2) NOT NULL,
            image_url VARCHAR(500),
            colors JSON,
            category VARCHAR(100),
            stock_quantity INT DEFAULT 0,
            is_active BOOLEAN DEFAULT true,
            createdAt TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
            updatedAt TIMESTAMP DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP
          );

          CREATE TABLE IF NOT EXISTS orders (
            id INT PRIMARY KEY AUTO_INCREMENT,
            userId INT,
            totalAmount DECIMAL(10,2) NOT NULL,
            status ENUM('Pending', 'Processing', 'Shipped', 'Delivered', 'Cancelled') DEFAULT 'Pending',
            shippingFirstName VARCHAR(100),
            shippingLastName VARCHAR(100),
            shippingAddress TEXT,
            shippingEmail VARCHAR(255),
            shippingPhoneNumber VARCHAR(20),
            shippingCity VARCHAR(100),
            shippingPostalCode VARCHAR(20),
            createdAt TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
            updatedAt TIMESTAMP DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP,
            FOREIGN KEY (userId) REFERENCES users(id) ON DELETE SET NULL
          );

          CREATE TABLE IF NOT EXISTS order_items (
            id INT PRIMARY KEY AUTO_INCREMENT,
            orderId INT NOT NULL,
            productId INT NOT NULL,
            quantity INT NOT NULL,
            price DECIMAL(10,2) NOT NULL,
            createdAt TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
            FOREIGN KEY (orderId) REFERENCES orders(id) ON DELETE CASCADE,
            FOREIGN KEY (productId) REFERENCES products(id) ON DELETE CASCADE
          );

          -- Insert test data
          INSERT INTO users (email, password, firstName, lastName, role) VALUES
          ('admin@test.com', '$2b$10$hashedpassword', 'Admin', 'User', 'admin'),
          ('user@test.com', '$2b$10$hashedpassword', 'Test', 'User', 'user');

          INSERT INTO products (name, description, price, image_url, category, stock_quantity) VALUES
          ('Test Product 1', 'Test description', 9.99, '/images/test1.jpg', 'test', 100),
          ('Test Product 2', 'Test description 2', 19.99, '/images/test2.jpg', 'test', 50);
          EOF
          
          # Verify tables were created
          echo "Verifying database setup..."
          mysql -h 127.0.0.1 -u fritid_user -pfritid_password fritid_db -e "SHOW TABLES;"
          mysql -h 127.0.0.1 -u fritid_user -pfritid_password fritid_db -e "SELECT COUNT(*) as user_count FROM users;"
          mysql -h 127.0.0.1 -u fritid_user -pfritid_password fritid_db -e "SELECT COUNT(*) as product_count FROM products;"
        working-directory: ./backend
        
      - name: Check backend startup
        run: |
          # Start the server in background and log to a file
          npm start > server.log 2>&1 &
          SERVER_PID=$!
          echo "Started server with PID: $SERVER_PID"
          
          # Wait for the success message with timeout
          echo "Waiting for server to start (checking for success message)..."
          timeout=60
          elapsed=0
          
          while [ $elapsed -lt $timeout ]; do
            if grep -q "Succesfuly made endpoints with no error found!" server.log; then
              echo "✅ Server started successfully! Found success message in log."
              # Kill the server
              kill $SERVER_PID
              echo "Server stopped"
              exit 0
            fi
            
            # Check if process crashed
            if ! kill -0 $SERVER_PID 2>/dev/null; then
              echo "❌ Server process crashed!"
              echo "Server logs:"
              cat server.log
              exit 1
            fi
            
            sleep 1
            elapsed=$((elapsed + 1))
          done
          
          # Timeout reached
          echo "❌ Timeout reached waiting for server startup message"
          echo "Server logs:"
          cat server.log
          kill $SERVER_PID 2>/dev/null
          exit 1
        working-directory: ./backend
        env:
          NODE_ENV: test
          DB_HOST: 127.0.0.1
          DB_USER: fritid_user
          DB_PASSWORD: fritid_password
          DB_NAME: fritid_db
          DB_PORT: 3306
          JWT_SECRET: test_jwt_secret_for_ci
          FULL_BACKEND_URL: localhost:8080/api
          MINIMAX_BASE_URL: https://api.minimax.example.com
          MINIMAX_BASIC_B64: dGVzdDp0ZXN0
          MINIMAX_USERNAME: test_user
          MINIMAX_PASSWORD: test_pass
          MINIMAX_ORG_ID: 195730

  test-frontend:
    runs-on: ubuntu-latest
    
    steps:
      - uses: actions/checkout@v4
      
      - uses: actions/setup-node@v4
        with:
          node-version: 20
          
      - name: Install frontend dependencies
        run: npm ci
        working-directory: ./frontend
        
      - name: Build frontend
        run: npm run build
        working-directory: ./frontend
        env:
          NODE_ENV: production
